{"version":3,"file":"index.modern.js","sources":["../src/index.js"],"sourcesContent":["import EventEmitter from 'eventemitter3';\nimport { PublicKey } from '@solana/web3.js';\nimport bs58 from 'bs58';\n\nexport default class Wallet extends EventEmitter {\n  constructor(provider, network) {\n    super();\n    if (isInjectedProvider(provider)) {\n      this._injectedProvider = provider;\n    } else if (isString(provider)) {\n      this._providerUrl = new URL(provider);\n      this._providerUrl.hash = new URLSearchParams({\n        origin: window.location.origin,\n        network,\n      }).toString();\n    } else {\n      throw new Error(\n        'provider parameter must be an injected provider or a URL string.',\n      );\n    }\n    this._network = network;\n    this._publicKey = null;\n    this._autoApprove = false;\n    this._popup = null;\n    this._handlerAdded = false;\n    this._nextRequestId = 1;\n    this._responsePromises = new Map();\n  }\n\n  _handleMessage = (e) => {\n    if (\n      (this._injectedProvider && e.source === window) ||\n      (e.origin === this._providerUrl.origin && e.source === this._popup)\n    ) {\n      if (e.data.method === 'connected') {\n        const newPublicKey = new PublicKey(e.data.params.publicKey);\n        if (!this._publicKey || !this._publicKey.equals(newPublicKey)) {\n          if (this._publicKey && !this._publicKey.equals(newPublicKey)) {\n            this._handleDisconnect();\n          }\n          this._publicKey = newPublicKey;\n          this._autoApprove = !!e.data.params.autoApprove;\n          this.emit('connect', this._publicKey);\n        }\n      } else if (e.data.method === 'disconnected') {\n        this._handleDisconnect();\n      } else if (e.data.result || e.data.error) {\n        if (this._responsePromises.has(e.data.id)) {\n          const [resolve, reject] = this._responsePromises.get(e.data.id);\n          if (e.data.result) {\n            resolve(e.data.result);\n          } else {\n            reject(new Error(e.data.error));\n          }\n        }\n      }\n    }\n  };\n\n  _handleConnect = () => {\n    if (this._injectedProvider) {\n      return new Promise((resolve) => {\n        this._sendRequest('connect', {});\n        resolve();\n      });\n    } else {\n      window.name = 'parent';\n      this._popup = window.open(\n        this._providerUrl.toString(),\n        '_blank',\n        'location,resizable,width=460,height=675',\n      );\n      return new Promise((resolve) => {\n        this.once('connect', resolve);\n      });\n    }\n  };\n\n  _handleDisconnect = () => {\n    if (this._publicKey) {\n      this._publicKey = null;\n      this.emit('disconnect');\n    }\n    this._responsePromises.forEach(([resolve, reject], id) => {\n      this._responsePromises.delete(id);\n      reject('Wallet disconnected');\n    });\n  };\n\n  _sendRequest = async (method, params) => {\n    if (method !== 'connect' && !this.connected) {\n      throw new Error('Wallet not connected');\n    }\n    const requestId = this._nextRequestId;\n    ++this._nextRequestId;\n    return new Promise((resolve, reject) => {\n      this._responsePromises.set(requestId, [resolve, reject]);\n      if (this._injectedProvider) {\n        this._injectedProvider.postMessage({\n          jsonrpc: '2.0',\n          id: requestId,\n          method,\n          params: {\n            network: this._network,\n            ...params,\n          },\n        });\n      } else {\n        this._popup.postMessage(\n          {\n            jsonrpc: '2.0',\n            id: requestId,\n            method,\n            params,\n          },\n          this._providerUrl.origin,\n        );\n\n        if (!this.autoApprove) {\n          this._popup.focus();\n        }\n      }\n    });\n  };\n\n  get publicKey() {\n    return this._publicKey;\n  }\n\n  get connected() {\n    return this._publicKey !== null;\n  }\n\n  get autoApprove() {\n    return this._autoApprove;\n  }\n\n  connect = () => {\n    if (this._popup) {\n      this._popup.close();\n    }\n    if (!this._handlerAdded) {\n      this._handlerAdded = true;\n      window.addEventListener('message', this._handleMessage);\n      window.addEventListener('beforeunload', this.disconnect);\n    }\n    return this._handleConnect();\n  };\n\n  disconnect = async () => {\n    if (this._injectedProvider) {\n      await this._sendRequest('disconnect', {});\n    }\n    if (this._popup) {\n      this._popup.close();\n    }\n    this._handleDisconnect();\n  };\n\n  signTransaction = async (transaction) => {\n    const response = await this._sendRequest('signTransaction', {\n      message: bs58.encode(transaction.serializeMessage()),\n    });\n    const signature = bs58.decode(response.signature);\n    const publicKey = new PublicKey(response.publicKey);\n    transaction.addSignature(publicKey, signature);\n    return transaction;\n  };\n\n  signAllTransactions = async (transactions) => {\n    const response = await this._sendRequest('signAllTransactions', {\n      messages: transactions.map((tx) => bs58.encode(tx.serializeMessage())),\n    });\n    const signatures = response.signatures.map((s) => bs58.decode(s));\n    const publicKey = new PublicKey(response.publicKey);\n    transactions = transactions.map((tx, idx) => {\n      tx.addSignature(publicKey, signatures[idx]);\n      return tx;\n    });\n    return transactions;\n  };\n}\n\nfunction isString(a) {\n  return typeof a === 'string';\n}\n\nfunction isInjectedProvider(a) {\n  return isObject(a) && isFunction(a.postMessage);\n}\n\nfunction isObject(a) {\n  return typeof a === 'object' && a !== null;\n}\n\nfunction isFunction(a) {\n  return typeof a === 'function';\n}\n"],"names":["Wallet","EventEmitter","constructor","provider","network","_handleMessage","e","_injectedProvider","source","window","origin","_providerUrl","_popup","data","method","newPublicKey","PublicKey","params","publicKey","_publicKey","equals","_handleDisconnect","_autoApprove","autoApprove","emit","result","error","_responsePromises","has","id","resolve","reject","get","Error","_handleConnect","Promise","_sendRequest","name","open","toString","once","forEach","delete","connected","requestId","_nextRequestId","set","postMessage","jsonrpc","_network","focus","connect","close","_handlerAdded","addEventListener","disconnect","signTransaction","transaction","response","message","bs58","encode","serializeMessage","signature","decode","addSignature","signAllTransactions","transactions","messages","map","tx","signatures","s","idx","isInjectedProvider","isString","URL","hash","URLSearchParams","location","Map","a","isObject","isFunction"],"mappings":"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"}